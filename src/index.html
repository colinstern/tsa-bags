<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/dc.css" />
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script src="js/d3.js"></script>
  <script src="js/crossfilter.js"></script>
  <script src="js/dc.js"></script>
  <script src="js/reductio.js"></script>
  <script src="js/universe.js"></script>
  <script type="text/javascript" src="js/colorbrewer.js"></script>
  <style>
  </style>
  <title>TSA Claims Dataset</title>

</head>

<body>
<!-- CSS -->



<!-- HTML -->

<div class="container">

  <h1>TSA Claims Dataset Metrics</h1>
  <h4>By <a href="http://cstern.me/">Colin Stern</a></h4>

  <h3>Time for a Vacation</h3>
  <div><span>​You're taking some much needed time off from work in Ney York City and you're planning to spend it in Miami, lounging on the beach sipping margaritas. However, since you don't live anywhere near Miami, <b>you're going to need to take a flight</b>.</span> </div>
  <img class="center-block" src="img/airplane-shape.svg" alt="View" style="width:100;height:100px;">
  <div> However, you want this flight to be as stress-free as possible - you've dealt with plenty of stress at work. You decide that losing bags is one of the most stressful experiences that could happen on your flight, so you decide to try to <b>minimize the possibility</b>.
  </div>
  <img class="center-block" src="img/bag.png" alt="View" style="width:140;height:140px;">
  <div> After some googling, you find historical records of claims from passengers sent to the TSA asking for compensation for lost or damaged bags. Using the data, you decide to plan your trip to avoid the airports and airlines which are most likely to ruin your trip by losing your bag. <b>Which airports and airlines should you avoid, and which should you take?</b></div>
    <img class="center-block" src="img/takeoff-the-plane.svg" alt="View" style="width:140;height:140px;">
    </span>

  <div>Let's take a look at the <b>worst offending airports....</b></div>
  <!-- Number of selected records -->
  <div class="row">
      <div>
          <div class="dc-data-count">
              <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                  href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
          </div>
      </div>
      <table class="table table-hover dc-data-table">
      </table>
  </div>
  <div class="clearfix"></div>


<!-- Heatmap - Airports by Volume of Claims-->
<div class="row">
  <div id="heatmap">
       <strong>Airports by Volume of Claims</strong>
       <a class="reset" href="javascript:airportHeatmap.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
       <div class="row">
         <div id="heat-select">
           <div>
             <a class="reset"
                href="javascript:heatSelect.filterAll();dc.redrawAll();"
                style="visibility: hidden;">reset</a>
           </div>
         </div>
       </div>
   </div>
</div>

  <p>​Clearly, <b>JFK</b> and <b>LaGuardia</b> lose the most bags of any airports in the area, while <b>Westchester County Airport</b> and <b>Stewart International Airport</b> are better alternatives.</p>


<!-- Heatmap key -->
<div class="row">
  <div id="heatmapKey">
    <div class="clearfix"></div>
  </div>
</div>

   <!--  Parallel coordinates - Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim goes here -->
<div class="row">
   <div id="parallel-coordinates">
        <strong>Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim</strong>
        <a class="reset" href="javascript:parallelCoordinates.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
        <div class="row">
        </div>
   </div>
 </div>

   <!-- Histogram - Number of Claims by Airline -->
   <p>​Now let's look at the <b>airlines...</b></p>
<div class="row">
     <div id="number-claims-by-airline-histogram">
          <strong>Number of Claims by Airline</strong>
          <a class="reset" href="javascript:numberClaimsByAirlineHistogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
          <div class="clearfix"></div>
          <div class="row">
            <div id="number-claims-by-airline-select">
              <div>
                <a class="reset"
                   href="javascript:numberClaimsByAirlineSelect.filterAll();dc.redrawAll();"
                   style="visibility: hidden;">reset</a>
              </div>
            </div>
          </div>
     </div>
</div>
<p style="padding-bottom:15px;">Our data says that <b>Southwest</b> and <b>Delta</b> lose the most bags, while <b>Virgin America</b> and <b>Emirates</b> are better alternatives.</p>

<!-- Line chart - Volume of Claims -->
<div class="row">
    <div id="volume-claims-line">
        <strong>Volume of Claims</strong>
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:volumeClaimsLine.filterAll();likeChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
        <div class="row">
          <div id="volume-claims-line-select">
            <div>
              <a class="reset"
                 href="javascript:volumeClaimsLineSelect.filterAll();dc.redrawAll();"
                 style="visibility: hidden;">reset</a>
            </div>
          </div>
        </div>

  <!-- Linked bar chart to line chart -->
      <div id="volume-claims-line-slider">
      </div>
      <p class="muted pull-right" style="margin-right: 15px;"></p>
  <p style="padding-bottom:15px;">Note</p>
</div>
</div>

<!-- Histogram - Percent of Denied Claims by Airport -->
<p style="padding-bottom:15px;">But what happens if you <i>do</i> lose your bags? Which airport is <b>most likely to compensate you?</b></p>
<div class="row">
  <div id="percent-denied-claims-by-airport-histogram">
       <strong>Percent of Denied Claims by Airport</strong>
       <a class="reset" href="javascript:percentDeniedByAirportHistogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
       <div class="row">
         <div id="percent-denied-by-airport-select">
           <div>
             <a class="reset"
                href="javascript:percentDeniedByAirportSelect.filterAll();dc.redrawAll();"
                style="visibility: hidden;">reset</a>
           </div>
         </div>
       </div>
   </div>
 </div>

 <p style="padding-bottom:15px;">JFK denies 60% of claims, which is about average. Meanwhile, Westchester County Airport denies 75% of claims and 
  <!-- Histogram - Number of Claims by Item Type -->
<div class="row">
    <div id="number-of-claims-by-item-histogram">
         <strong>Number of Claims by Item Type</strong>
         <a class="reset" href="javascript:numberClaimsItemHistogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
         <div class="clearfix"></div>
         <div class="row">
           <div id="number-claims-item-histogram-select">
             <div>
               <a class="reset"
                  href="javascript:numberClaimsItemHistogramSelect.filterAll();dc.redrawAll();"
                  style="visibility: hidden;">reset</a>
             </div>	
         </div>
       </div>
    </div>

</div>

<div class="row">
  <p style="padding-bottom:15px;">Note</p>
</div>

</div>


<!-- JavaScript -->
<script>
'use strict';

  /* Parse and format */
  <!-- Parsing Dates -->
  var dateParser = d3.time.format("%d-%b-%y").parse;

  // Formatting axes
  var percentFormat = d3.format(".0%");

  // Formatting decimals
  var roundFormat = d3.format(".2r");	

  /* Create chart objects */

  /* count selected records */
  var claimsCount = dc.dataCount('.dc-data-count');

  // Airport Heatmap
  var airportHeatmap = dc.geoChoroplethChart('#heatmap');
  // var heatmapKey = dc.heatMap("#heatmapKey");
  // var heatSelect = dc.selectMenu('#heat-select');

  // Percent of Denied Claims by Airport Histogram
  var percentDeniedByAirportHistogram = dc.barChart('#percent-denied-claims-by-airport-histogram');
  // var percentDeniedByAirportSelect = dc.selectMenu('#percent-denied-by-airport-select');

  //  Parallel coordinates - Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim goes here

  // Number of Claims by Airline Histogram
  var numberClaimsByAirlineHistogram = dc.barChart('#number-claims-by-airline-histogram');
  // var numberClaimsByAirlineSelect = dc.selectMenu('#number-claims-by-airline-select');

  // Volume of Claims Line Chart
  var volumeClaimsLine = dc.lineChart('#volume-claims-line');
  // var volumeClaimsLineSelect = dc.selectMenu('#volume-claims-line-select');
  // var volumeClaimsLineSlider = dc.barChart('#volume-claims-line-slider');

  // Number of Claims by Item Type Histogram
  // var numberClaimsItemHistogram = dc.barChart('#number-of-claims-by-item-histogram');
  // var numberClaimsItemHistogramSelect = dc.selectMenu('#number-claims-item-histogram-select');


<!-- Data Input -->
  d3.csv('data/claims-data-2015-as-of-feb-9-2016-ADDEDLATLONG.csv', function(data) {
        // Variable names
        var var1 = "ClaimNumber";
        var var2 = "DateReceived";
        var var3 = "IncidentDate";
        var var4 = "AirportCode";
        var var5 = "AirportName";
        var var6 = "AirlineName";
        var var7 = "ClaimType";
        var var8 = "ClaimSite";
        var var9 = "ItemCategory";
        var var10 = "CloseAmount";
        var var11 = "Disposition";
        var var12 = "Lat";
        var var13 = "Long";

        data.forEach(function (d) {
          d[var1]=+d[var1];
          d[var11]=+d[var11];
          d[var12]=+d[var12];
          d[var13]=+d[var13];

          // Calculate date of claim
          d.claimDate = dateParser(d[var2]);
          d.claimMonth = d3.time.month(d.claimDate);
        });

<!-- CrossFilter -->
var ndx = crossfilter(data),
    all = ndx.groupAll(),
    heatmapAirportsDim = ndx.dimension(function(d) {return d[var4];}),
    histogramAirportsDim = ndx.dimension(function(d) {return d[var4];}),
    // parallel coordinates dimension
    histogramAirlineDim = ndx.dimension(function(d) {return d[var6];}),
    lineClaimsDim = ndx.dimension(function(d) {return d.claimMonth;}),
    histogramItemDim = ndx.dimension(function(d) {return d[var9];}),

    heatmapAirportsGroup = heatmapAirportsDim.group().reduce(
      function (p, v) {
        ++p.count;
        p.lat = v[var12];
        p.long = v[var13];
        return p;
      },
      function (p, v) {
        --p.count;
        p.lat = v[var12];
        p.long = v[var13];
        return p;
      },
      function () {
        return {
          count: 0,
          lat: 0,
          long: 0,
        };
      }
    ),
    histogramAirportsGroup = histogramAirportsDim.group().reduce(
      function (p, v) {
        ++p.count;
        p.sum += v[var11];
        p.avg = (p.sum / p.count) ? (p.sum / p.count) : 0;
        return p;
      },
      function (p, v) {
        --p.count;
        p.sum -= v[var11];
        p.avg = (p.sum / p.count) ? (p.sum / p.count) : 0;
        return p;
      },
      function () {
        return {
          count: 0,
          sum: 0,
          avg: 0
        };
      }
    ),
    //parallel coordinates
    histogramAirlineGroup = histogramAirlineDim.group().reduce(
      function (p, v) {
        ++p.count;
        return p;
      },
      function (p, v) {
        --p.count;
        return p;
      },
      function () {
        return {
          count: 0
        };
      }
    ),
    lineClaimsGroup = lineClaimsDim.group().reduce(
      function (p, v) {
        ++p.count;
        p.sum += v[var11];
        p.avg = (p.sum / p.count);
        return p;
      },
      function (p, v) {
        --p.count;
        p.sum -= v[var11];
        p.avg = (p.sum / p.count);
        return p;
      },
      function () {
        return {
          count: 0,
          sum: 0,
          avg: 0
        };
      }
    ),
    histogramItemGroup = histogramItemDim.group();


// airportHeatmap is moved to end of file due to call to renderAll within the JSON callback
// console.log(heatmapAirportsGroup.top(Infinity));





<!-- Histogram - Percent of Denied Claims by Airport -->
// A hack to allow sorting
histogramAirportsGroup.order(function(d) {
	// console.log(d);
    return d.avg;
});

histogramAirportsGroup.all = function() {
    return histogramAirportsGroup.top(Infinity);
}

percentDeniedByAirportHistogram
    .width(1250)
    .height(200)
    .dimension(histogramAirportsDim)
    .group(histogramAirportsGroup)
    .yAxisLabel("Percent of Claims Denied")
    .xAxisLabel("Airport")
    // due to 0 to 100 percent range of denied claims
    .x(d3.scale.ordinal().domain(function(d) {return d.key;}))
    .valueAccessor(function (d) { return d.value.avg;})
    .keyAccessor(function(d) { return d.key; })
    .centerBar(false)
    .elasticX(true)
    .elasticY(true)
    .title(function(d) {return d.key + ": " + percentFormat(d.value.avg) + " denied"})
    .xUnits(dc.units.ordinal)
    .ordering(function(d){
    return d.value.avg })
    .xAxis().tickFormat(function(d) { return ""; });
  percentDeniedByAirportHistogram.yAxis().ticks(6);
  percentDeniedByAirportHistogram.yAxis().tickFormat(percentFormat);

<!-- Parallel Coordinates - Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim -->


<!-- Histogram - Number of Claims by Airline -->
// A hack to allow sorting
histogramAirlineGroup.order(function(d) {
	// console.log(d);
    return d.count;
});

histogramAirlineGroup.all = function() {
    return histogramAirlineGroup.top(Infinity);
}


numberClaimsByAirlineHistogram
  .width(1250)
  .height(200)
  .dimension(histogramAirlineDim)
  .group(histogramAirlineGroup)
  .yAxisLabel("Number of Claims")
  .xAxisLabel("Airline")
  .x(d3.scale.ordinal().domain(function(d) {return d.key;}))
  .y(d3.scale.sqrt().domain([0, 1400]))
  .valueAccessor(function (d) { return d.value.count;})
  .keyAccessor(function(d) { return d.key; })
  .elasticX(true)
  .elasticY(true)
  .xUnits(dc.units.ordinal)
  .ordering(function(d){
    return d.value.count })
  .title(function(d) {return d.key + ": " + d.value.count + " claims"})
  .xAxis().tickFormat(function(d) { return ""; });
  // .valueAccessor(function (d) { return d.value.count;  })
  // .keyAccessor(function(d) { return d.key; });


<!-- Line chart - Volume of Claims: -->
volumeClaimsLine
  .width(900)
  .height(200)
  // .chart(function(c) { return dc.lineChart(c).interpolate('linear');})
  .x(d3.time.scale().domain([new Date(2015, 0, 1), new Date(2015, 11, 31)]))
  // .xUnits(dc.units.ordinal)
  .yAxisLabel("Number of Claims")
  .xAxisLabel('Date')
  .elasticY(true)
  .dimension(lineClaimsDim)
  .group(lineClaimsGroup)
  .valueAccessor(function (d) {return d.value.count;})
  .keyAccessor(function(d) {return d.key;})
  .renderHorizontalGridLines(true)
  .legend(dc.legend().x(600).y(0).itemHeight(10).gap(3).horizontal(2).legendWidth(140).itemWidth(40));
volumeClaimsLine.yAxis().ticks(6);


<!-- Histogram - Number of Claims by Item Type -->

<!-- Count selected records widget -->

claimsCount
    .dimension(ndx)
    .group(all)
    .html({
        some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records' +
            ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'>Reset All</a>',
        all: 'All records selected. Please click on the graph to apply filters.'
    });


d3.json("/json/us-states.json", function (statesJson) {

	<!-- HeatMap - Airports by Volume of Claims -->
	airportHeatmap
		.width(990)
		.height(500)
		.dimension(heatmapAirportsDim)
		.group(heatmapAirportsGroup)
		.colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
	    .colorDomain([0, 200])
	    .colorCalculator(function (d) { return d ? airportHeatmap.colors()(d) : '#ccc'; })
        .overlayGeoJson(statesJson.features, "state", function (d) {
            return d.properties.name;
        })
        .valueAccessor(function(kv) {
            // console.log(kv);
            return kv.value.count;
        })	
        .title(function (d) {
        	
        	// console.log(d);
                        return "State: " + d.key;
        })
        .on("renderlet", drawAdditionalStuffInMap);		

        function drawAdditionalStuffInMap(_chart, selection) {
		    var svg = _chart.svg();
		    svg.selectAll("g.additionalStuff").remove();

		    var group = svg.selectAll("g.additionalStuff");

		    if (group.empty()) {
		        group = svg.append("g").classed("additionalStuff", true);
		    }

            var proj = airportHeatmap.geoPath().projection();
            var nodes = group.selectAll("circle").data(heatmapAirportsGroup.top(Infinity),
            	function(d) {
            		var posn = proj([d.value.long, d.value.lat]);
            		// console.log(posn); 
            		if (posn !== null) {
            			return [posn[0], posn[1], d.value.count];
            		}
            		else {
            			return [0,0,0];
            		}
            	})	

            // nodes.enter()
            // 	.append("circle")
            		// .attr("x", function(d){return d[0]})
            		// .attr("y", function(d){return d[1]})
		    //you need to implement calculateAdditionalDataPoints
		    // var additionalData = calculateAdditionalDataPoints();
		    // var additionalNodes = group.selectAll("circle").data(additionalData, function(x) { return x.id; });


		    // _chart.dimension().top(Infinity).map(function(d) {
		    //         d.location = proj([d.Long, d.Lat]);
		    //         return d;
		    // });


		    // });

		    nodes.enter()
		        .append("svg:image")
		            .attr("x", 0)
		            .attr("y", 0)
		            .attr('width', function(d) {return 3*Math.sqrt(d.value.count)})
				   	.attr('height', function(d) {return 3*Math.sqrt(d.value.count)	})
				   	.attr("xlink:href","img/airplane-shape.svg")
		            // .attr("r", function(d) {return d.value.count})
		            .attr("transform", function(d){
		             var posn = proj([d.value.long, d.value.lat]);
		             // console.log(d); 
		             if (posn !== null) {
		           	  return "translate(" + posn[0] + "," + posn[1] + ")"; 
		        	 }
		        	 else {
		        	 	return "translate(" + 120 + "," + 200 + ")";
		        	 }})
	            .append("title")
				  .text(function(d) { return "\n" +d.key+"\n"+d.value.count + " claims"; });;

		    nodes.exit().remove();
}	


	<!-- Render -->
	dc.renderAll();
	// console.log(airportHeatmap.geoPath().projection());
});


// end of data input callback
  });

</script>
</body>
