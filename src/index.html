<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/dc.css" />
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script src="js/d3.js"></script>
  <script src="js/crossfilter.js"></script>
  <script src="js/dc.js"></script>
  <script src="js/reductio.js"></script>
  <script src="js/universe.js"></script>
  <script type="text/javascript" src="js/colorbrewer.js"></script>
  <style>
  </style>
  <title>TSA Claims Dataset</title>

</head>

<body>
<!-- CSS -->




<!-- HTML -->

<div class="container">

  <h1>TSA Claims Dataset Metrics</h1>
  <h4>By <a href="http://cstern.me/">Colin Stern</a></h4>


  <!-- Number of selected records -->
  <div class="row">
      <div>
          <div class="dc-data-count">
              <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                  href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
          </div>
      </div>
      <table class="table table-hover dc-data-table">
      </table>
  </div>
  <div class="clearfix"></div>


<!-- Heatmap - Airports by Volume of Claims-->
<div class="row">
  <div id="heatmap">
       <strong>Airports by Volume of Claims</strong>
       <a class="reset" href="javascript:airportHeatmap.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
       <div class="row">
         <div id="heat-select">
           <div>
             <a class="reset"
                href="javascript:heatSelect.filterAll();dc.redrawAll();"
                style="visibility: hidden;">reset</a>
            <p>Filter</p>
           </div>
         </div>
       </div>
   </div>
</div>

<!-- Heatmap key -->
<div class="row">
  <div id="heatmapKey">
    <div class="clearfix"></div>
  </div>
  <p style="padding-bottom:15px;">Note</p>
</div>


<!-- Histogram - Percent of Denied Claims by Airport -->
<div class="row">
  <div id="percent-denied-claims-by-airport-histogram">
       <strong>Percent of Denied Claims by Airport</strong>
       <a class="reset" href="javascript:percentDeniedByAirportHistogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
       <div class="row">
         <div id="percent-denied-by-airport-select">
           <div>
             <a class="reset"
                href="javascript:percentDeniedByAirportSelect.filterAll();dc.redrawAll();"
                style="visibility: hidden;">reset</a>
            <p>Filter</p>
           </div>
         </div>
       </div>
   </div>
 </div>


   <!--  Parallel coordinates - Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim goes here -->
<div class="row">
   <div id="parallel-coordinates">
        <strong>Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim</strong>
        <a class="reset" href="javascript:parallelCoordinates.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
        <div class="row">
        </div>
   </div>
 </div>

   <!-- Histogram - Number of Claims by Airline -->
<div class="row">
     <div id="number-claims-by-airline-histogram">
          <strong>Number of Claims by Airline</strong>
          <a class="reset" href="javascript:numberClaimsByAirlineHistogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
          <div class="clearfix"></div>
          <div class="row">
            <div id="number-claims-by-airline-select">
              <div>
                <a class="reset"
                   href="javascript:numberClaimsByAirlineSelect.filterAll();dc.redrawAll();"
                   style="visibility: hidden;">reset</a>
               <p>Filter</p>
              </div>
            </div>
          </div>
     </div>
</div>

<!-- Line chart - Volume of Claims -->
<div class="row">
    <div id="volume-claims-line">
        <strong>Volume of Claims</strong>
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:volumeClaimsLine.filterAll();likeChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
        <div class="row">
          <div id="volume-claims-line-select">
            <div>
              <a class="reset"
                 href="javascript:volumeClaimsLineSelect.filterAll();dc.redrawAll();"
                 style="visibility: hidden;">reset</a>
             <p>Filter</p>
            </div>
          </div>
        </div>

  <!-- Linked bar chart to line chart -->
      <div id="volume-claims-line-slider">
      </div>
      <p class="muted pull-right" style="margin-right: 15px;"></p>
  <p style="padding-bottom:15px;">Note</p>
</div>
</div>

  <!-- Histogram - Number of Claims by Item Type -->
<div class="row">
    <div id="number-of-claims-by-item-histogram">
         <strong>Number of Claims by Item Type</strong>
         <a class="reset" href="javascript:numberClaimsItemHistogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
         <div class="clearfix"></div>
         <div class="row">
           <div id="number-claims-item-histogram-select">
             <div>
               <a class="reset"
                  href="javascript:numberClaimsItemHistogramSelect.filterAll();dc.redrawAll();"
                  style="visibility: hidden;">reset</a>
              <p>Filter</p>
             </div>
         </div>
       </div>
    </div>

</div>

<div class="row">
  <p style="padding-bottom:15px;">Note</p>
</div>

</div>


<!-- JavaScript -->
<script>
'use strict';

  /* Parse and format */
  <!-- Parsing Dates -->
  var dateParser = d3.time.format("%d-%b-%y").parse;

  /* Create chart objects */

  /* count selected records */
  var claimsCount = dc.dataCount('.dc-data-count');

  // Airport Heatmap
  // var airportHeatmap = dc.heatMap('#heatmap');
  // var heatmapKey = dc.heatMap("#heatmapKey");
  // var heatSelect = dc.selectMenu('#heat-select');

  // Percent of Denied Claims by Airport Histogram
  var percentDeniedByAirportHistogram = dc.barChart('#percent-denied-claims-by-airport-histogram');
  // var percentDeniedByAirportSelect = dc.selectMenu('#percent-denied-by-airport-select');

  //  Parallel coordinates - Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim goes here

  // Number of Claims by Airline Histogram
  // var numberClaimsByAirlineHistogram = dc.lineChart('#number-claims-by-airline-histogram');
  // var numberClaimsByAirlineSelect = dc.selectMenu('#number-claims-by-airline-select');

  // Volume of Claims Line Chart
  var volumeClaimsLine = dc.lineChart('#volume-claims-line');
  // var volumeClaimsLineSelect = dc.selectMenu('#volume-claims-line-select');
  // var volumeClaimsLineSlider = dc.barChart('#volume-claims-line-slider');

  // Number of Claims by Item Type Histogram
  // var numberClaimsItemHistogram = dc.barChart('#number-of-claims-by-item-histogram');
  // var numberClaimsItemHistogramSelect = dc.selectMenu('#number-claims-item-histogram-select');


<!-- Data Input -->
  d3.csv('data/test-set.csv', function(data) {
        // Variable names
        var var1 = "ClaimNumber";
        var var2 = "DateReceived";
        var var3 = "IncidentDate";
        var var4 = "AirportCode";
        var var5 = "AirportName";
        var var6 = "AirlineName";
        var var7 = "ClaimType";
        var var8 = "ClaimSite";
        var var9 = "ItemCategory";
        var var10 = "CloseAmount";
        var var11 = "Disposition";

        data.forEach(function (d) {
          d[var1]=+d[var1];
          d[var11]=+d[var11];

          // Calculate date of claim
          d.claimDate = dateParser(d[var2]);
          d.claimMonth = d3.time.month(d.claimDate);
        });

<!-- CrossFilter -->
var ndx = crossfilter(data),
    all = ndx.groupAll(),
    heatmapAirportsDim = ndx.dimension(function(d) {return d[var4];}),
    histogramAirportsDim = ndx.dimension(function(d) {return d[var4];}),
    // parallel coordinates dimension
    histogramAirlineDim = ndx.dimension(function(d) {return d[var6];}),
    lineClaimsDim = ndx.dimension(function(d) {return d.claimMonth;}),
    histogramItemDim = ndx.dimension(function(d) {return d[var9];}),

    heatmapAirportsGroup = heatmapAirportsDim.group(),
    histogramAirportsGroup = histogramAirportsDim.group().reduce(
      function (p, v) {
        ++p.count;
        p.sum += v[var11];
        p.average = Math.round(p.sum / p.count);
        return p;
      },
      function (p, v) {
        --p.count;
        p.sum -= v[var11];
        p.average = Math.round(p.sum / p.count);
        return p;
      },
      function () {
        return {
          count: 0,
          sum: 0,
          avg: 0
        };
      }
    ),
    //parallel coordinates
    histogramAirlineGroup = histogramAirlineDim.group().reduce(
      function (p, v) {
        ++p.count;
        return p;
      },
      function (p, v) {
        --p.count;
        return p;
      },
      function () {
        return {
          count: 0
        };
      }
    ),
    lineClaimsGroup = lineClaimsDim.group().reduce(
      function (p, v) {
        ++p.count;
        p.sum += v[var11];
        p.average = Math.round(p.sum / p.count);
        return p;
      },
      function (p, v) {
        --p.count;
        p.sum -= v[var11];
        p.average = Math.round(p.sum / p.count);
        return p;
      },
      function () {
        return {
          count: 0,
          sum: 0,
          avg: 0
        };
      }
    ),
    histogramItemGroup = histogramItemDim.group();

<!-- HeatMap - Airports by Volume of Claims -->


<!-- Histogram - Percent of Denied Claims by Airport -->
percentDeniedByAirportHistogram
    .width(300)
    .height(200)
    .dimension(histogramAirportsDim)
    .group(histogramAirportsGroup)
    .yAxisLabel("Percent of Claims Denied")
    .xAxisLabel("Airport")
    // due to 0 to 100 percent range of denied claims
    .x(d3.scale.linear().domain([0, 100]))
    .valueAccessor(function (d) { return d.value.average;  })
    .keyAccessor(function(d) { return d.key; })
    .centerBar(false)
    .elasticX(true)
    .elasticY(true);
  percentDeniedByAirportHistogram.yAxis().ticks(6);

<!-- Parallel Coordinates - Correlations between Airport, Airline, Where Item was Lost, Close Amount and Disposition of Claim -->


<!-- Histogram - Number of Claims by Airline -->


<!-- Line chart - Volume of Claims: -->
volumeClaimsLine
  .width(700)
  .height(200)
  // .chart(function(c) { return dc.lineChart(c).interpolate('linear');})
  .x(d3.time.scale().domain([new Date(2015, 0, 1), new Date(2015, 11, 31)]))
  // .xUnits(dc.units.ordinal)
  .yAxisLabel("Number of claims")
  .xAxisLabel('Date')
  .elasticY(true)
  .dimension(lineClaimsDim)
  .group(lineClaimsGroup)
  .valueAccessor(function (d) {return d.value.count;})
  .keyAccessor(function(d) {return d.key;})
  .renderHorizontalGridLines(true)
  .legend(dc.legend().x(600).y(0).itemHeight(10).gap(3).horizontal(2).legendWidth(140).itemWidth(40));
volumeClaimsLine.yAxis().ticks(6);


<!-- Histogram - Number of Claims by Item Type -->

<!-- Count selected records widget -->

claimsCount
    .dimension(ndx)
    .group(all)
    .html({
        some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records' +
            ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'>Reset All</a>',
        all: 'All records selected. Please click on the graph to apply filters.'
    });


<!-- Render -->
dc.renderAll();

// end of data input callback
  });

</script>
</body>
